---
layout: default
---


<script src="{{site.baseurl}}/assets/js/jsencrypt.min.js"></script>
<script src="{{site.baseurl}}/assets/js/jszip.min.js"></script>
<script src="{{site.baseurl}}/assets/js/jquery.min.js"></script>
<script src="{{site.baseurl}}/assets/js/jstree.min.js"></script>
<script type="text/javascript" src="{{site.baseurl}}/assets/js/processing.min.js"></script>
<script src="{{site.baseurl}}/assets/js/polyfill.min.js?features=es6"></script>
<script id="MathJax-script" async src="{{site.baseurl}}/assets/js/mathjax/tex-mml-chtml.js"></script>
<script src="{{site.baseurl}}/assets/js/skel.min.js"></script>
<script src="{{site.baseurl}}/assets/js/util.js"></script>
<script src="{{site.baseurl}}/assets/js/main.js"></script>
<script src="{{site.baseurl}}/assets/js/ace.js" type="text/javascript" charset="utf-8"></script>

<script src="{{site.baseurl}}/assets/js/gl-matrix-min.js"></script>
<script src="{{site.baseurl}}/assets/js/d3.v3.min.js" type="text/javascript" charset="utf-8"></script>

<script type="text/javascript" src = "{{site.baseurl}}/assets/js/ggslac/jslibs/dat.gui.min.js"></script>
<script type="text/javascript" src = "{{site.baseurl}}/assets/js/ggslac/jslibs/webgl-utils.js"></script>
<script type="text/javascript" src = "{{site.baseurl}}/assets/js/ggslac/jslibs/webgl-debug.js"></script>

<script src="{{site.baseurl}}/assets/js/ggslac/geometry/polymesh.js"></script>
<script src="{{site.baseurl}}/assets/js/ggslac/geometry/basicmesh.js"></script>
<script src="{{site.baseurl}}/assets/js/ggslac/geometry/primitives3d.js"></script>
<script src="{{site.baseurl}}/assets/js/ggslac/geometry/cameras3d.js"></script>
<script src="{{site.baseurl}}/assets/js/ggslac/shaders/shaders.js"></script>
<script src="{{site.baseurl}}/assets/js/ggslac/utils/simpledraw.js"></script>

<script src="{{site.baseurl}}/assets/js/ggslac/viewers/basecanvas.js"></script>
<script src="{{site.baseurl}}/assets/js/ggslac/viewers/scenecanvas.js"></script>
<script src="{{site.baseurl}}/assets/js/ggslac/viewers/matrixanim.js"></script>



<style>
.image_off, #home:hover .image_on{
   display:none
}
.image_on, #home:hover .image_off{
   display:block
}

#feedbackText {
    position: relative;
    width: 700px;
    height: 100px;
}

</style>

<div id="main" role="main">
  <div class="archive">    
    <h1 class="page__title">{{ page.title }}{% if page.info.points %} ({{page.info.points}} Points){% endif %}</h1>
         Graphics content developed by <a href="http://www.ctralie.com">Chris Tralie</a>.  Module autograding ecosystem designed by <a href="http://www.ctralie.com">Chris Tralie</a> and <a href = "http://www.billmongan.com/">Bill Mongan</a>.

        {% if page.info.prev or page.info.next %}
        <p>
        {% if page.info.prev %}
        <button onclick="window.location.href = '{{ page.info.prev }} ';"> &lt--- Previous</button>
        {% endif %}
        {% if page.info.next %}
        <button onclick="window.location.href = '{{ page.info.next }}';">Next ---&gt</button>
        {% endif %}
        </p>
        <HR>
        {% endif %}
        
        {% if page.info.goals %}
        <h1>Exercise Goals</h1>
        The goals of this exercise are:
        <ol>
        {% for goal in page.info.goals %}
        <li>{{goal}}</li>
        {% endfor %}
        </ol>
        {% endif %}
        
        {% if page.info.instructions %}
        {{ page.info.instructions }}
        {% endif %}
        
        <div id="correctArea"></div>
        
        <p>
        <strong>Enter your Ursinus netid before clicking the Check/Submit button.  This is <u>not</u> your ID number or your email.  For example, my netid is <code>ctralie</code> (non Ursinus students can simply enter their name to get this to check for correctness, but they won't get any form of credit)</strong> 
        </p>
        
        <table>
            <tr>
                <td>
                    Netid
                </td>
                <td>
                    <input type="text" id="studentnetid" name="studentnetid" onchange="if(document.getElementById('studentnetid').value.length > 0) document.getElementById('runbutton').disabled = false; else document.getElementById('runbutton').disabled = true;">
                </td>
            </tr>
        </table>
        {% if layout.formprocessor and layout.formprocessor != false %}
        {{ layout.formprocessordirections }}<br>
        {% endif %}
        {% if page.processor.submitformlink and page.processor.submitformlink != false %}
        {{ layout.submitformlinkdirections }}<br>
        {% endif %}
        
        <button type = "button" onclick = "if(document.getElementById('studentnetid').value.length > 0) runCode(); else correctArea.innerHTML = '<h3><font color = #AA0000>Please enter your netid first!</font></h3>';" id="runbutton" disabled>Check/Submit</button>
        </p>
        
        <!-- Must name main file "main" and the div tag here/css/processing code below is hardcoded to mainEditor -->
        {% for file in page.files %}
        {% if file.isvisible == true %}
        <h3>{{ file.filename }}</h3>
        {% endif %}
        
        {% if file.ismain == true %}<div id="mainEditor">{% else %}<div id="{{ file.name }}Editor">{% endif %}{{ file.code | strip }}</div>
        {% endfor %}


        <script>
        const courseid = '{% if page.canvascourseid %}{{ page.canvascourseid }}{% else %}{{ site.canvascourseid }}{% endif %}';
        const asmtid = '{{ page.canvasasmtid }}';
        const publicKey = `{% if layout.publickey %}{{ layout.publickey }}{% else %}{{ site.publickey }}{% endif %}`;
        let shaderPath = "{{site.baseurl}}/assets/js/ggslac/shaders/";
        let meshesPath = "{{site.baseurl}}/assets/js/ggslac/meshes/";
        {{ page.processor.setupprocess | strip }}
        let correctArea = document.getElementById("correctArea");
        let correctlyAnswered = false;
        let numAttempts = 0;
        let outputToSend = ""; // What to send to canvas

        // https://stackoverflow.com/questions/7542586/new-formdata-application-x-www-form-urlencoded
        function urlencodeFormData(fd){
            var s = '';
            function encode(s){ return encodeURIComponent(s).replace(/%20/g,'+'); }
            for(var pair of fd.entries()){
                if(typeof pair[1]=='string'){
                    s += (s?'&':'') + encode(pair[0])+'='+encode(pair[1]);
                }
            }
            return s;
        }

        function arrayBufferToBase64(buffer) {
            let binary = '';
            const bytes = new Uint8Array(buffer);
            const len = bytes.byteLength;
            for (let i = 0; i < len; i++) {
                binary += String.fromCharCode(bytes[i]);
            }
            return window.btoa(binary);
        }


        async function encryptFiles(halfcredit, points) {
            const aesKey = await window.crypto.subtle.generateKey(
                {
                    name: 'AES-CBC',
                    length: 256,
                },
                true,
                ['encrypt', 'decrypt']
            );

            const iv = window.crypto.getRandomValues(new Uint8Array(16));
            const encoder = new TextEncoder();

            const encryptedFiles = [];
            const encodedContent = encoder.encode(outputToSend);
            const encryptedContent = await window.crypto.subtle.encrypt(
                {
                    name: 'AES-CBC',
                    iv: iv,
                },
                aesKey,
                encodedContent
            );
            encryptedFiles.push({
                name: "matrixOutput.txt",
                content: arrayBufferToBase64(encryptedContent)
            });

            const exportedAesKey = await window.crypto.subtle.exportKey('raw', aesKey);
            const rsaEncrypt = new JSEncrypt();
            rsaEncrypt.setPublicKey(publicKey);
            const encryptedAesKey = rsaEncrypt.encrypt(arrayBufferToBase64(exportedAesKey));

            // Encrypt the userId
            const userId = document.getElementById("studentnetid").value.toLowerCase();
            const encodedUserId = encoder.encode(userId);
            const encryptedUserId = await window.crypto.subtle.encrypt(
                {
                    name: 'AES-CBC',
                    iv: iv,
                },
                aesKey,
                encodedUserId
            );

            if (encryptedAesKey) {
                const encryptedPackage = {
                    iv: arrayBufferToBase64(iv.buffer),
                    aesKey: encryptedAesKey,
                    files: encryptedFiles,
                    user: arrayBufferToBase64(encryptedUserId), 
                    courseId: courseid,
                    asmtId: asmtid,
                    halfcredit: halfcredit,
                    points: points
                };

                return window.btoa(JSON.stringify(encryptedPackage));
            } else {
                throw new Error("Encryption failed.");
            }
        }

        async function postCode(halfcredit, points) {
            // download encrypted submission version
            const encryptedContent = await encryptFiles(halfcredit, points);

            let url = `{% if layout.formlink %}{{ layout.formlink }}{% else %}{{ site.formlink }}{% endif %}` + encryptedContent;
            console.log("len(url)", url.length);
            window.location.href = url; // window.open(url);
        }

        function runCode() {
            const points = {% if page.info.points %}{{page.info.points}}{% else %}0{% endif %};
            numAttempts++;
            {{ page.processor.feedbackprocess | strip }}
            if ({{ page.processor.correctcheck | strip}}) {
                correctlyAnswered = true;
                correctArea.innerHTML = "<h3><font color = #00AA00>{{ page.processor.correctfeedback | strip}}</font></h3>";
                <!-- Setting a page.processor.submitformlink in the markdown will pop up an iframe with a page of your choice -->
                {% if page.processor.submitformlink and page.processor.submitformlink != false %}
                correctArea.innerHTML += `
                <iframe src = "{{ page.processor.submitformlink | strip }}" width=800 height=500>
                `;
                {% endif %}
                
                postCode(false, points);
            }
            {% if page.processor.incorrectchecks %}
            {% for check in page.processor.incorrectchecks %}
            else if ({{ check.incorrectcheck | strip}}) {
                correctArea.innerHTML = "<h3><font color = red>{{ check.feedback | strip }}</font></h3>";
            }
            {% endfor %}
            {% endif %}
            else {
                correctArea.innerHTML = "<h3><font color = red>{{ page.processor.incorrectfeedback | strip }}</font></h3>";
            }

            {% if page.canvashalftries %}
            if (!correctlyAnswered && numAttempts == {{ page.canvashalftries }}) {
                postCode(true, points);
            }


            {% endif %}

        }
        </script>        
        
    {{ content }} 
  </div>
</div>
